<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
<title>ë¡œê³ ê³„ì¢Œíƒ€ì„</title>
</head>
<script type="module">

// ìµœì í™” ë¬¸ì œë¡œ íŒŒí¸ ì• ë‹ˆë©”ì´ì…˜ ì™„ì „ ë¹„í™œì„±í™”, íŒŒí¸ ë‚˜ì˜¤ê²Œ í•˜ë ¤ë©´ ì•„ë˜ í•œ ì¤„ë§Œ ì£¼ì„ì²˜ë¦¬
window.createBricksBatch = () => {};

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
  authDomain: "mygps-11798.firebaseapp.com",
  projectId: "mygps-11798",
  storageBucket: "mygps-11798.firebasestorage.app",
  messagingSenderId: "271371741627",
  appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const lettersCol = collection(db, "letters");
const wordListCol = collection(db, "wordList");

  let typingLoopActive = true;
  let animationFrameId = null; // 1. ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ID ì €ì¥ìš©

  let wordList = []; // âœ… ì „ì—­ ë°°ì—´

  window.onload = async function () {
    time();
    await loadWordList();
    typing();
  };

  async function fetchLetters() {
    const q = query(lettersCol, orderBy("timestamp", "asc"));
    const snapshot = await getDocs(q);
    const letters = snapshot.docs.map(doc => doc.data().text);
    return letters;
  }

  async function loadWordList() {
    const q = query(wordListCol, orderBy("timestamp", "asc"));
    const snapshot = await getDocs(q);
    
    wordList = []; // ì´ˆê¸°í™”
    snapshot.forEach(doc => {
      const data = doc.data();
      wordList.push({
        words: data.words,   // ["í›„ì›", "êµ¬ë…"]
        color: data.color    // "red" | "#FFC700" | "#6495ED"
      });
    });
    wordList.push({ words: ["ã…¡"], color: "transparent" });
    //console.log("wordList ë¶ˆëŸ¬ì˜´:", wordList);
  }
    
  async function typing() {
    const $text = document.querySelector(".typing .text");
    const letters = await fetchLetters(); // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°

    //const wordList = [
      //{ words: ["L", "í›„ì›", "êµ¬ë…", "ê°ì‚¬", "ë‹¤ì‹œ", "YOON", "Ù©", "Ùˆ"], color: "red" }, // ë¹¨ê°•
      //{ words: ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", ".", "â˜…", "á—œ", "*"], color: "#FFC700" }, // ë…¸ë‘
      //{ words: ["AGAIN"], color: "#6495ED" }, // íŒŒë‘
      //{ words: ["ã…¡"], color: "transparent" } // íˆ¬ëª…
    //];

    const speed = 115; // íƒ€ì´í•‘ ì†ë„
    let i = 0;

    const wait = (ms) => new Promise(res => setTimeout(res, ms));

    const typingFunc = async () => {
      if (!typingLoopActive) return;
      $text.innerHTML = ""; // ë³€ê²½ëœ ë¶€ë¶„ (innerHTML)
      const raw = letters[i];
      const typingChars = [];
      const consumed = Array(raw.length).fill(false);

      for (const group of wordList) {
        for (const word of group.words) {
          let startIndex = 0;
          while (startIndex < raw.length) {
            const index = raw.indexOf(word, startIndex);
            if (index === -1) break;
            for (let j = 0; j < word.length; j++) {
              typingChars[index + j] = { char: word[j], color: group.color };
              consumed[index + j] = true;
            }
            startIndex = index + 1;
          }
        }
      }

      for (let j = 0; j < raw.length; j++) {
        if (!consumed[j]) {
          typingChars[j] = { char: raw[j], color: "white" };
        }
      }

      for (const { char, color } of typingChars) {
        if (!typingLoopActive) return;
        await wait(speed);
        const span = document.createElement("span");
        span.textContent = char;
        span.style.color = color;
        if (color === "transparent") {
          span.style.textShadow = "none"; // í…Œë‘ë¦¬ë„ ìˆ¨ê¹€
        }
        $text.appendChild(span);

        const rect = span.getBoundingClientRect();
        const x = rect.right + window.scrollX + 15; // ì‹œì‘ìœ„ì¹˜ ì˜¤ë¥¸ìª½
        const y = rect.top + rect.height / 2 + window.scrollY + 10; // ì‹œì‘ìœ„ì¹˜ ë†’ì´

        const actualColor = (color === "transparent") ? "white" : color;
        createBricksBatch(x, y, actualColor, 10);
      }

      await wait(14000); // ê¸€ì ë©ˆì¶¤ ì‹œê°„
      reverseTyping();
    };

    const reverseTyping = async () => {
      const spans = Array.from($text.childNodes).reverse();

      for (let span of spans) {
        if (!typingLoopActive) return;
        await wait(speed);
        const rect = span.getBoundingClientRect();
        const x = rect.left + rect.width / 2 + window.scrollX;
        const y = rect.top + rect.height / 2 + window.scrollY + 10;

        const color = (span.style.color === "transparent") ? "white" : span.style.color;
        createBricksBatch(x, y, color, 10);

        // ë©”ëª¨ë¦¬ ìµœì í™” ì ìš© ë¶€ë¶„
        span.remove();
        span.textContent = "";
        span.removeAttribute("style");
        span.removeAttribute("class");
        span = null;
      }

      $text.innerHTML = ""; // ë³€ê²½ëœ ë¶€ë¶„ (innerHTML)
      i = (i + 1) % letters.length;
      typingFunc();
    };

    setTimeout(typingFunc, 1000);
  }

  (function () {
    // ìœ„ì— íŒŒí¸ ê¸°ëŠ¥ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì „ì²´ íŒŒí¸ ì½”ë“œ ì‹¤í–‰ ì¤‘ë‹¨
    if (window.createBricksBatch && window.createBricksBatch.toString() === "() => {}") {
      return;
    }
    
    const brickPool = [];
    const MAX_POOL = 80;
    let activeBricks = [];
    let isAnimating = false;

    function getBrick() {
      if (brickPool.length > 0) return brickPool.pop();
      const div = document.createElement("div");
      div.className = "brick";
      return div;
    }

    function recycleBrick(brick) {
      if (!brick) return;
      brick.style.cssText = "";
      brick.removeAttribute("style");
      brick.removeAttribute("class");
      brick.className = "brick";
      brick.style.display = "none";
      brick.style.opacity = 1;
      brick.fading = false;

      if (brick.__data__) {
        brick.__data__.element = null;
        brick.__data__ = null;
      }
      brickPool.push(brick);

      while (brickPool.length > MAX_POOL) {
        const removed = brickPool.shift();
        removed.remove();
      }
    }

    function animateBricks() {
      const gravity = 0.5;	// íŒŒí¸ ì¤‘ë ¥
      const friction = 0.6;	// íŒŒí¸ ë²”ìœ„

      for (let b of activeBricks) {
        if (!b.falling) continue;
        b.dy += gravity;
        b.posX += b.dx;
        b.posY += b.dy;

        if (b.posY >= b.ground) {
          b.posY = b.ground;
          b.dy = 0;
          b.dx *= friction;
          if (Math.abs(b.dx) < 0.1) b.dx = 0;
          b.falling = false;

          if (!b.waitingToRemove) {
            b.waitingToRemove = true;
            if (b.timeoutId) clearTimeout(b.timeoutId);
            b.timeoutId = setTimeout(() => {
              b.removed = true;
              recycleBrick(b.element);
              b.element = null;
            }, 200);	// íŒŒí¸ ì‚¬ë¼ì§€ëŠ” ì‹œê°„
          }
        }

        if (b.element) {
          b.element.style.left = b.posX + "px";
          b.element.style.top = b.posY + "px";
        }
      }

      activeBricks = activeBricks.filter(b => !b.removed);
      if (activeBricks.length > 0) {
        animationFrameId = requestAnimationFrame(animateBricks);
      } else {
        isAnimating = false;
      }
    }

    window.createBricksBatch = function (x, y, color = "white", count = 10) {
      const fragment = document.createDocumentFragment();
      const bricksToAnimate = [];

      for (let i = 0; i < count; i++) {
        const brick = getBrick();
        brick.style.left = x + "px";
        brick.style.top = y + "px";
        brick.style.background = color;
        brick.style.border = "2px solid black";
        brick.style.opacity = 1;
        brick.style.display = "block";

        fragment.appendChild(brick);

        const dx = (Math.random() - 0.5) * 6;
        const dy = (Math.random() - 1.5) * 6;

        const brickData = {
          element: brick,
          posX: x,
          posY: y,
          dx: dx,
          dy: dy,
          ground: y,
          falling: true,
          waitingToRemove: false,
          timeoutId: null,
          removed: false
        };

        brick.__data__ = brickData;
        bricksToAnimate.push(brickData);
      }

      document.body.appendChild(fragment);
      activeBricks.push(...bricksToAnimate);

      if (!isAnimating) {
        isAnimating = true;
        animationFrameId = requestAnimationFrame(animateBricks);
      }
    };
  })();

  let prevTimeStr = "";
  let timeChangeTimeouts = [];

  function time() {
    const today = new Date();
    const hours = ("0" + today.getHours()).slice(-2);
    const minutes = ("0" + today.getMinutes()).slice(-2);
    const currentTimeStr = hours + ":" + minutes;

    const timeEl = document.getElementById("time");
    timeEl.innerHTML = "";

    timeChangeTimeouts.forEach(id => clearTimeout(id));
    timeChangeTimeouts = [];

    for (let i = 0; i < currentTimeStr.length; i++) {
      const span = document.createElement("span");
      span.textContent = currentTimeStr[i];

      if (prevTimeStr && currentTimeStr[i] !== prevTimeStr[i]) {
        span.classList.add("time-change");
        const timeoutId = setTimeout(() => {
          span.classList.remove("time-change");
        }, 50); // ì´ˆ í›„ ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë˜ëŒë¦¼
        timeChangeTimeouts.push(timeoutId);
      }

      timeEl.appendChild(span);
    }

    prevTimeStr = currentTimeStr;
  }

  const timeInterval = setInterval(time, 60000);

  window.addEventListener("beforeunload", function () {
    clearInterval(timeInterval);
    typingLoopActive = false;
    window.createBricksBatch = () => {};
    if (animationFrameId !== null) cancelAnimationFrame(animationFrameId);
  });
  //------------------------------ë‰´ìŠ¤-----------------------------------------
//import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
//import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// âœ… Firebase ì„¤ì • (ì»¨íŠ¸ë¡¤ í˜ì´ì§€ì™€ ë™ì¼í•´ì•¼ í•¨)
//const firebaseConfig = {
//  apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
//  authDomain: "mygps-11798.firebaseapp.com",
//  databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
//  projectId: "mygps-11798",
//  storageBucket: "mygps-11798.firebasedestorage.app",
//  messagingSenderId: "271371741627",
//  appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
//};

//const app = initializeApp(firebaseConfig);
//const db = getDatabase(app);

const newsEl = document.getElementById("news");
const API_URL = "https://newstts-production-0424.up.railway.app/news";

let isPaused = false;
let isHidden = false;

// âœ… Firebase ttsControl.playing ì‹¤ì‹œê°„ ê°ì§€
const controlRef = ref(db, "ttsControl");
onValue(controlRef, (snapshot) => {
  const data = snapshot.val();
  if (!data) return;
  // â–¶ ì¬ìƒ/ì¼ì‹œì •ì§€
  if (data.playing === false) {
    pauseScroll();
  } else if (data.playing === true && !isHidden) {
    // ğŸ‘ ìˆ¨ê¹€ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ì¬ìƒ ê°€ëŠ¥
    resumeScroll();
  }
  // ê¸€ì í¬ê¸° ë°˜ì˜
  if (data.fontSize) {
    newsEl.style.fontSize = data.fontSize + "px";
  }
  // ğŸ‘ ìˆ¨ê¹€ ì œì–´ (ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ë³´ì¡´)
  if (data.hiddenText === true && !isHidden) {
    isHidden = true;
    // í˜„ì¬ ìƒíƒœ ì €ì¥
    const currentState = getComputedStyle(newsEl).animationPlayState;
    newsEl.dataset.prevState = currentState;
    // ì• ë‹ˆë©”ì´ì…˜ ë©ˆì¶¤ + ìˆ¨ê¹€
    newsEl.style.animationPlayState = "paused";
    newsEl.style.visibility = "hidden";
  } else if (data.hiddenText === false && isHidden) {
    isHidden = false;
    // ë‹¤ì‹œ í‘œì‹œí•˜ê³  ì´ì „ ìƒíƒœ ë³µì›
    newsEl.style.visibility = "visible";
    const prev = newsEl.dataset.prevState || "running";
    newsEl.style.animationPlayState = prev;
  }
});

// âœ… ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadNews() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    if (data.news) startScroll(data.news);
  } catch (err) {
    console.error("ë‰´ìŠ¤ ë¡œë”© ì‹¤íŒ¨", err);
  }
}

// âœ… ë‰´ìŠ¤ ìŠ¤í¬ë¡¤ ì‹œì‘
function startScroll(text) {
  newsEl.textContent = text;

  const wrapperWidth = newsEl.parentElement.offsetWidth;
  const textWidth = newsEl.offsetWidth;
  const speed = 100; // px/sec
  const duration = (wrapperWidth + textWidth) / speed;

  // ğŸ”¹ ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ (ì¬ì‹œì‘ ë³´ì¥)
  newsEl.style.animation = "none";
  newsEl.offsetHeight; // â† ë¦¬í”Œë¡œìš° ê°•ì œ (ì¤‘ìš”!)
  newsEl.style.animation = `scroll linear ${duration}s 1`;
  newsEl.style.animationPlayState = "running";
  isPaused = false;

  newsEl.onanimationend = async () => {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      if (data.news) startScroll(data.news); // ë‹¤ìŒ ë‰´ìŠ¤ ë°˜ë³µ
    } catch (err) {
      console.error("ë‹¤ìŒ ë‰´ìŠ¤ ë¡œë”© ì‹¤íŒ¨", err);
    }
  };
}

// âœ… ì¼ì‹œì •ì§€ / ì¬ê°œ
function pauseScroll() {
  if (!isPaused) {
    newsEl.style.animationPlayState = "paused";
    isPaused = true;
  }
}

function resumeScroll() {
  if (isPaused) {
    newsEl.style.animationPlayState = "running";
    isPaused = false;
  }
}

// âœ… í˜ì´ì§€ ì²˜ìŒ ì‹¤í–‰ ì‹œ ë‰´ìŠ¤ ì‹œì‘
loadNews();
</script>
<style>
  body {
  font-family: "HYìš¸ë¦‰ë„B", "Montserrat", "Noto Sans KR", sans-serif;
  }
  .typing {
    position: relative;
  }
  .brick {
    position: absolute;
    width: 12px;
    height: 12px;
    background: white;
    border: 1px solid black;
    border-radius: 3px;
    pointer-events: none;
    z-index: 9999;
    opacity: 1;
  }
  #time span {
    color: white;
    transition: color 5s ease; /* ë¶€ë“œëŸ½ê²Œ ìƒ‰ìƒ ì „í™˜ */
  }
  .time-change {
    color: #FFC700 !important;
  }
  tr {
    /* ê¸€ì ë°°ê²½ ë°•ìŠ¤ */
    display: inline-block;
  	background: rgba(0, 0, 68, 1);
  	line-height: 0.8;								/* ë°•ìŠ¤ ìœ„ìª½ ìœ„ì¹˜ */
    padding: 0px 20px 5px 20px;		/* ë°•ìŠ¤ ì•„ë˜ìª½ ìœ„ì¹˜  ìƒ ìš° í•˜ ì¢Œ */
    border-radius: 10px;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
  }
  /* -----------------------------------ë‰´ìŠ¤---------------------------------------- */
  body {
    margin: 0;
    background: transparent;
    overflow: hidden;
  }

  #wrapper {
    white-space: nowrap;
    overflow: hidden;
    position: fixed;
    bottom: 0;
    left: 0;
    /* transform: translateY(8px);  ì•„ë˜ë¡œ ê°•ì œ ìœ„ì¹˜ ì´ë™ */ 
    width: 100vw;
    height: 100px;
    z-index: 9999;
  }

  #news {
    display: inline-block;
    font-size: 60px;
    color: white;  /* ê³¨ë“œ #FFC700 */
    font-weight: bold;
    text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black,
                 -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;
    will-change: transform;
    backface-visibility: hidden;
    position: absolute;
    bottom: 0;
    white-space: nowrap;
    animation-name: scroll;
    animation-timing-function: linear;
    animation-iteration-count: 1;

    /* ê¸€ì ë°°ê²½ ë°•ìŠ¤ */
  	background: rgba(0, 0, 51, 1);  /* ë‚¨ìƒ‰ê³„ì—´ 26, 34, 51, (0,26,68) */
  	line-height: 0.8;								/* ë°•ìŠ¤ ìœ„ìª½ ìœ„ì¹˜ */
    padding: 0px 10px 10px 10px;		/* ë°•ìŠ¤ ì•„ë˜ìª½ ìœ„ì¹˜  ìƒ ìš° í•˜ ì¢Œ */
    border-radius: 10px;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
  }

  @keyframes scroll {
    from { transform: translateX(100vw); }
    to { transform: translateX(-100%); }
  }
</style>
<body>
  <br />
  <table border="0">
  	<tr>
  		<td>
  			<div id="wrapper">
  				<div id="news">ë‰´ìŠ¤ ë¡œë”© ì¤‘...</div>
				</div>
  		</td>
  	</tr>
    <tr>
      <td width="975" style="vertical-align: top; text-align: right; white-space: nowrap; overflow: hidden; max-width: 975px; padding-top: 0px; padding-left: 0px; padding-right: 100px;">
        <span class="typing" style="color: white; font-size: 45px; font-weight: bold; font-family: hyìš¸ë¦‰ë„b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;">
          <span id="textcolor" class="text" style="white-space: pre;"></span>
        </span>
        <span style="color: white; font-size: 45px; font-weight: bold; font-family: hyìš¸ë¦‰ë„b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;">
          <font color="#FFC700">&ensp;&ensp;&ensp;ì¹´ì¹´ì˜¤</font> 33330-7696-7896 <font color="#6495ED">ì˜¤Jí•œ</font>
        </span>
      </td>
      <td style="vertical-align: top; text-align: right; padding-top: 0px; padding-left: 35px;">
        <span id="time" style="color: white; font-size: 45px; font-weight: bold; font-family: hyìš¸ë¦‰ë„b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;"></span>
      </td>
    </tr>
  </table>
</body>
</html>
