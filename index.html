<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>뉴스 스크롤 컨트롤</title>
<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
  color: white;
  font-family: sans-serif;
}
#wrapper {
  white-space: nowrap;
  overflow: hidden;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 50px;
}
#news {
  display: inline-block;
  font-size: 28px;
  font-weight: bold;
  text-shadow: 1px 1px 2px black;
  position: absolute;
  top: 0;
  white-space: nowrap;
  animation-name: scroll;
  animation-timing-function: linear;
  animation-iteration-count: 1;
}
@keyframes scroll {
  from { transform: translateX(100vw); }
  to { transform: translateX(-100%); }
}

/* 버튼 스타일 */
button { font-size: 20px; margin: 5px; }
</style>
</head>
<body>

<div id="wrapper"><div id="news">뉴스 로딩 중...</div></div>

<div style="position: fixed; top: 60px; left: 10px;">
  <button id="playBtn">▶ 재생</button>
  <button id="pauseBtn">‖ 일시정지</button>
  <button id="rewindBtn"><< 5초 되감기</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// Firebase 초기화
const firebaseConfig = {
  apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
  authDomain: "mygps-11798.firebaseapp.com",
  databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mygps-11798",
  storageBucket: "mygps-11798.firebasedestorage.app",
  messagingSenderId: "271371741627",
  appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const newsEl = document.getElementById("news");
const wrapper = document.getElementById("wrapper");
let wrapperWidth = wrapper.offsetWidth;
let textWidth = 0;
let speed = 100; // px/sec
let duration = 0;
let paused = false;

// 뉴스 가져오기
async function loadNews() {
  try {
    const res = await fetch("https://newstts-production-b5a7.up.railway.app/news");
    const data = await res.json();
    if (data.news) startScroll(data.news);
  } catch (err) { console.error(err); }
}

function startScroll(text) {
  newsEl.textContent = text;
  textWidth = newsEl.offsetWidth;
  duration = (wrapperWidth + textWidth) / speed;

  // CSS 애니메이션 초기화
  newsEl.style.animation = "none";
  newsEl.offsetHeight; // 리플로우
  newsEl.style.animation = `scroll linear ${duration}s 1`;
  newsEl.style.animationPlayState = "running";
  paused = false;

  newsEl.addEventListener("animationend", function handler() {
    newsEl.removeEventListener("animationend", handler);
    loadNews(); // 다음 뉴스
  });
}

// --- 일시정지 ---
function pauseScroll() {
  if (paused) return;
  paused = true;

  const style = getComputedStyle(newsEl);
  const matrix = new DOMMatrixReadOnly(style.transform);
  newsEl.dataset.currentX = matrix.m41; // 현재 위치 저장
  newsEl.style.animationPlayState = "paused";
}

// --- 재생 ---
function resumeScroll() {
  if (!paused) return;
  paused = false;

  const currentX = parseFloat(newsEl.dataset.currentX || 0);
  const remainingDistance = currentX + textWidth; // 현재 위치에서 끝까지 거리
  const remainingTime = remainingDistance / speed;

  // transform 임시 적용 후 애니메이션 이어감
  newsEl.style.animation = "none";
  newsEl.offsetHeight;
  newsEl.style.transform = `translateX(${currentX}px)`;
  setTimeout(() => {
    newsEl.style.animation = `scroll linear ${remainingTime}s 1`;
    newsEl.style.animationPlayState = "running";
  }, 20);
}

// --- 5초 되감기 ---
function rewindScroll() {
  const style = getComputedStyle(newsEl);
  const matrix = new DOMMatrixReadOnly(style.transform);
  let currentX = matrix.m41;

  // 5초 되감기
  currentX = Math.min(currentX + 5 * speed, wrapperWidth);
  newsEl.style.animation = "none";
  newsEl.style.transform = `translateX(${currentX}px)`;

  // 잠깐 후 애니메이션 이어가기
  setTimeout(() => {
    const remainingDistance = currentX + textWidth;
    const remainingTime = remainingDistance / speed;
    newsEl.style.animation = `scroll linear ${remainingTime}s 1`;
    newsEl.style.animationPlayState = paused ? "paused" : "running";
  }, 20);
}

// 버튼 이벤트
document.getElementById("playBtn").onclick = resumeScroll;
document.getElementById("pauseBtn").onclick = pauseScroll;
document.getElementById("rewindBtn").onclick = rewindScroll;

// Firebase 연동
onValue(ref(db, "ttsControl"), snapshot => {
  const val = snapshot.val();
  if (!val) return;
  if (val.playing === true) resumeScroll();
  if (val.playing === false) pauseScroll();
  if (val.back === -5) rewindScroll();
});

// 초기 뉴스 로딩
loadNews();

</script>
</body>
</html>
